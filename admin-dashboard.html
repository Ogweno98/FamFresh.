<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin Dashboard — FamFresh</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Header -->
  <div class="bg-white shadow sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="rounded-full bg-green-600 w-10 h-10 flex items-center justify-center text-white font-bold">FF</div>
        <div>
          <h1 class="font-bold text-lg">FamFresh Admin</h1>
          <p class="text-xs text-gray-500">Dashboard</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span class="text-sm text-gray-700" id="adminName">Admin</span>
        <button id="logoutBtn" class="text-sm text-red-600">Logout</button>
      </div>
    </div>
  </div>

  <main class="max-w-6xl mx-auto px-4 py-8 grid md:grid-cols-3 gap-6">

    <!-- Products Section -->
    <section class="md:col-span-2 space-y-6">
      <div class="bg-white p-4 rounded shadow">
        <h3 class="font-semibold">All Products</h3>
        <div id="allProducts" class="mt-4 grid sm:grid-cols-2 gap-4"></div>
      </div>

      <!-- Orders Section -->
      <div class="bg-white p-4 rounded shadow">
        <h3 class="font-semibold">Recent Orders</h3>
        <div id="ordersList" class="mt-3 text-sm text-gray-700"></div>
      </div>
    </section>

    <!-- Users Section -->
    <aside class="space-y-6">
      <div class="bg-white p-4 rounded shadow">
        <h4 class="font-semibold">All Users</h4>
        <div id="usersList" class="mt-3 text-sm text-gray-700"></div>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h4 class="font-semibold">Quick Actions</h4>
        <div class="mt-3 flex flex-col gap-2">
          <button id="seedProducts" class="bg-green-700 text-white px-3 py-2 rounded">Seed Demo Products</button>
          <button id="refreshDashboard" class="bg-blue-700 text-white px-3 py-2 rounded">Refresh Data</button>
        </div>
      </div>
    </aside>

  </main>

  <div id="chatbot-root"></div>

  <script src="firebase-init.js"></script>
  <script src="app.js"></script>
  <script src="chatbot.js"></script>

  <script>
    // Auth guard — only allow admin
    appAuth.onAuthStateChanged(async user=>{
      if(!user) return location.href='login.html';
      const doc = await db.collection('users').doc(user.uid).get();
      const data = doc.exists ? doc.data() : {};
      if(data.role !== 'admin') return alert('Access denied'), location.href='login.html';
      if(document.getElementById('adminName')) document.getElementById('adminName').textContent = data.name || data.email;
    });

    // Render products
    async function renderProducts(){
      const ct = document.getElementById('allProducts');
      ct.innerHTML='';
      const prods = await appData.getProducts();
      prods.forEach(p=>{
        const el = document.createElement('div');
        el.className='p-3 border rounded';
        el.innerHTML=`
          <img src="${p.image||''}" class="h-28 w-full object-cover rounded">
          <h4 class="mt-2 font-semibold">${p.name}</h4>
          <div class="text-sm text-gray-600">KES ${p.price} / ${p.unit||'kg'}</div>
          <div class="text-xs text-gray-500">${p.category}</div>
          <div class="mt-2 flex gap-2">
            <button class="editBtn border px-2 py-1 rounded">Edit</button>
            <button class="delBtn border px-2 py-1 rounded text-red-600">Delete</button>
          </div>`;
        ct.appendChild(el);

        el.querySelector('.delBtn').addEventListener('click', async ()=>{
          if(confirm('Delete product?')){
            await appData.removeProduct?.(p.id);
            renderProducts();
          }
        });
        el.querySelector('.editBtn').addEventListener('click', async ()=>{
          const newPrice = prompt('New price (KES)', p.price);
          if(newPrice) { await appData.updateProduct?.(p.id,{price:Number(newPrice)}); renderProducts(); }
        });
      });
    }

    // Render users
    async function renderUsers(){
      const ct = document.getElementById('usersList');
      ct.innerHTML='';
      const snap = await db.collection('users').orderBy('createdAt','desc').get();
      snap.docs.forEach(d=>{
        const u = d.data();
        const el = document.createElement('div');
        el.className='p-2 border-b';
        el.innerHTML=`${u.name||u.email} - <span class="text-xs text-gray-500">${u.role}</span>`;
        ct.appendChild(el);
      });
    }

    // Render orders (demo)
    async function renderOrders(){
      const ct = document.getElementById('ordersList');
      ct.innerHTML='';
      const snap = await db.collection('bookings').orderBy('createdAt','desc').limit(10).get();
      if(snap.empty){ ct.textContent='No orders yet'; return; }
      snap.docs.forEach(d=>{
        const o = d.data();
        const div = document.createElement('div');
        div.className='border-b p-2';
        div.innerHTML=`<div class="text-sm">${o.userName || o.email} booked ${o.item || 'item'} x ${o.quantity||1} - KES ${o.total||0}</div>`;
        ct.appendChild(div);
      });
    }

    // Seed demo products
    document.getElementById('seedProducts').addEventListener('click', async ()=>{
      await appData.seedIfEmpty();
      await renderProducts();
      alert('Demo products seeded');
    });

    // Refresh dashboard
    document.getElementById('refreshDashboard').addEventListener('click', async ()=>{
      await renderProducts();
      await renderUsers();
      await renderOrders();
    });

    // Initial load
    renderProducts();
    renderUsers();
    renderOrders();

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', ()=>{ appAuth.logout(); location.href='login.html'; });
  </script>
</body>
</html>